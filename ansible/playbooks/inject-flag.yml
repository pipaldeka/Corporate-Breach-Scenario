# ansible/playbooks/inject-flag.yml

---
- name: Inject Unique Flag into Scenario
  hosts: localhost
  connection: local
  
  vars:
    container_name: "{{ scenario }}-db-{{ student_id }}"
    flag: "{{ flag }}"
  
  tasks:
    - name: Generate random flag if not provided
      set_fact:
        flag: "FLAG{{{ lookup('password', '/dev/null chars=ascii_letters,digits length=32') }}}"
      when: flag is not defined or flag == ""
    
    - name: Inject flag into database
      docker_container_exec:
        container: "{{ container_name }}"
        command: >
          mysql -uroot -prootpass123 challenge_db
          -e "UPDATE flags SET flag_value='{{ flag }}' WHERE flag_id=1;"
    
    - name: Verify flag injection
      docker_container_exec:
        container: "{{ container_name }}"
        command: >
          mysql -uroot -prootpass123 challenge_db
          -e "SELECT flag_value FROM flags;"
      register: verify_flag
    
    - debug:
        var: verify_flag.stdout_lines
