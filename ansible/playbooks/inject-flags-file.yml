---
- name: Inject Flags into Container Files
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    student_id: "{{ student_id }}"
    scenario: "{{ scenario }}"
    container_name: "{{ container_name }}"
    num_flags: "{{ num_flags | default(1) }}"
    flag1: "{{ flag1 | default('') }}"
    flag2: "{{ flag2 | default('') }}"
    flag3: "{{ flag3 | default('') }}"
    flag4: "{{ flag4 | default('') }}"
    flag5: "{{ flag5 | default('') }}"
  
  tasks:
    - name: Display injection info
      debug:
        msg:
          - "Injecting {{ num_flags }} flag(s) into {{ container_name }}"
          - "Student: {{ student_id }}"
          - "Scenario: {{ scenario }}"
    
    - name: Wait for container to be ready
      command: docker exec {{ container_name }} test -d /var/www/html || docker exec {{ container_name }} test -d /home
      register: container_check
      until: container_check.rc == 0
      retries: 30
      delay: 2
      changed_when: false
    
    - name: Create flags directory
      command: docker exec {{ container_name }} mkdir -p /flags
      changed_when: false
    
    - name: Inject flags dynamically
      command: >
        docker exec {{ container_name }}
        bash -c "echo '{{ item.value }}' > /flags/flag{{ item.index }}.txt"
      loop:
        - { index: 1, value: "{{ flag1 }}" }
        - { index: 2, value: "{{ flag2 }}" }
        - { index: 3, value: "{{ flag3 }}" }
        - { index: 4, value: "{{ flag4 }}" }
        - { index: 5, value: "{{ flag5 }}" }
      when: 
        - item.index <= (num_flags | int)
        - item.value != ''
    
    - name: Set permissions on flags
      command: >
        docker exec {{ container_name }}
        bash -c "
          for i in {1..{{ num_flags }}}; do
            if [ -f /flags/flag\$i.txt ]; then
              if [ \$i -eq {{ num_flags }} ]; then
                chown root:root /flags/flag\$i.txt && chmod 600 /flags/flag\$i.txt
              else
                chown www-data:www-data /flags/flag\$i.txt && chmod 644 /flags/flag\$i.txt
              fi
            fi
          done
        "
      changed_when: false
    
    - name: Verify flags
      command: docker exec {{ container_name }} ls -la /flags/
      register: flags_verify
      changed_when: false
    
    - name: Display verification
      debug:
        msg: "{{ flags_verify.stdout_lines }}"
    
    - name: Create metadata directory
      file:
        path: /var/log/cyber-range
        state: directory
        mode: '0755'
      ignore_errors: yes
    
    - name: Save flag metadata
      copy:
        dest: "/var/log/cyber-range/{{ student_id }}-{{ scenario }}-flags.json"
        content: |
          {
            "student_id": "{{ student_id }}",
            "scenario": "{{ scenario }}",
            "container": "{{ container_name }}",
            "num_flags": {{ num_flags }},
            "flags": {
              {% if flag1 != '' %}"flag1": "{{ flag1 }}"{% if num_flags > 1 %},{% endif %}{% endif %}
              {% if flag2 != '' %}"flag2": "{{ flag2 }}"{% if num_flags > 2 %},{% endif %}{% endif %}
              {% if flag3 != '' %}"flag3": "{{ flag3 }}"{% if num_flags > 3 %},{% endif %}{% endif %}
              {% if flag4 != '' %}"flag4": "{{ flag4 }}"{% if num_flags > 4 %},{% endif %}{% endif %}
              {% if flag5 != '' %}"flag5": "{{ flag5 }}"{% endif %}
            },
            "injected_at": "{{ ansible_date_time.iso8601 }}"
          }
        mode: '0600'
      ignore_errors: yes
    
    - name: Success message
      debug:
        msg: "âœ… Successfully injected {{ num_flags }} flag(s) into {{ container_name }}"
