# scenarios/corporate-breach/docker-compose.yml

version: '3.8'

services:
  corporate-server:
    build: .
    container_name: corporate-breach-${STUDENT_ID:-test}
    hostname: cybercorp-internal
    environment:
      - DB_HOST=mysql-db          # ← Changed from localhost
      - DB_USER=webapp_user
      - DB_PASS=webapp_password_123
      - DB_NAME=corporate_db
      - FLAG1=FLAG{user_level_access_achieved}
      - FLAG2=FLAG{database_credentials_compromised}
      - FLAG3=FLAG{root_access_game_over}
    ports:
      - "${WEB_PORT:-8080}:80"
      - "${SSH_PORT:-2222}:22"
    networks:
      scenario_network:
        ipv4_address: 10.100.${VLAN_SUBNET:-1}.10
    depends_on:                    # ← Add this
      - mysql-db
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor=unconfined
    restart: unless-stopped

  mysql-db:                        # ← ADD THIS ENTIRE BLOCK
    image: mysql:8.0
    container_name: corporate-mysql-${STUDENT_ID:-test}
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: corporate_db
      MYSQL_USER: webapp_user
      MYSQL_PASSWORD: webapp_password_123
    volumes:
      - ./database:/docker-entrypoint-initdb.d  # Auto-runs init.sql
    networks:
      scenario_network:
        ipv4_address: 10.100.${VLAN_SUBNET:-1}.11
    restart: unless-stopped

networks:
  scenario_network:
    name: student-vlan-${VLAN_ID:-101}
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.${VLAN_SUBNET:-1}.0/24
          gateway: 10.100.${VLAN_SUBNET:-1}.1

